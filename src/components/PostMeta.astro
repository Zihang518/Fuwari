---
import { Icon } from "astro-icon/components";

import { umamiConfig } from "../config";
import { formatDateToYYYYMMDD } from "../utils/date-utils";
import { url, getDir } from "../utils/url-utils";

interface Props {
	class: string;
	published: Date;
	updated?: Date;
	hideUpdateDate?: boolean;
	hidePublishedDate?: boolean;
	slug?: string;
}
const {
	published,
	updated,
	hideUpdateDate = false,
	hidePublishedDate = false,
	slug,
} = Astro.props;
const className = Astro.props.class;
---

<div class:list={["flex flex-wrap text-neutral-500 dark:text-neutral-400 items-center gap-4 gap-x-4 gap-y-2", className]}>
    <!-- publish date -->
    {!hidePublishedDate && (
        <div class="flex items-center">
            <div class="meta-icon">
                <Icon name="material-symbols:calendar-today-outline-rounded" class="text-xl"></Icon>
            </div>
            <span class="text-50 text-sm font-medium">{formatDateToYYYYMMDD(published)}</span>
        </div>
    )}

    <!-- update date -->
    {!hideUpdateDate && updated && updated.getTime() !== published.getTime() && (
        <div class="flex items-center">
            <div class="meta-icon"
            >
                <Icon name="material-symbols:edit-calendar-outline-rounded" class="text-xl"></Icon>
            </div>
            <span class="text-50 text-sm font-medium">{formatDateToYYYYMMDD(updated)}</span>
        </div>
    )}

    <!-- page views & visitors -->
    {slug && (
        <>
            <div class="flex items-center">
                <div class="meta-icon">
                    <Icon name="material-symbols:visibility-outline-rounded" class="text-xl"></Icon>
                </div>
                <span class="text-50 text-sm font-medium" id={`page-views-${slug}`}>0 æ¬¡</span>
            </div>
            <!--
            <div class="flex items-center">
                <div class="meta-icon">
                    <Icon name="material-symbols:person" class="text-xl"></Icon>
                </div>
                <span class="text-50 text-sm font-medium" id={`page-visitors-${slug}`}>0 äºº</span>
            </div>
            -->
        </>
    )}
</div>

{slug && (
    <script define:vars={{ slug, umamiConfig }}>
    // æ•°å­—åŠ¨ç”»å‡½æ•°
    function animateValue(obj, start, end, duration, suffix = '') {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = `${Math.floor(progress * (end - start) + start)} ${suffix}`;
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                obj.innerHTML = `${end} ${suffix}`;
            }
        };
        window.requestAnimationFrame(step);
    }

    // è·å–è®¿é—®é‡ç»Ÿè®¡ (Archived: Old Logic)
    /*
    async function fetchPageViews() {
        // å¦‚æœä½ æ²¡åœ¨ config é‡Œå¼€å¯ umami æˆ–è€…æ²¡å¡« shareIdï¼Œå°±ç›´æ¥é€€å‡º
        if (!umamiConfig || !umamiConfig.shareId) return;

        try {
            // ğŸ’¡ ç›´æ¥è¯·æ±‚ Umami å®˜æ–¹çš„å…¬å¼€æ•°æ®æ¥å£
            // è¿™é‡Œçš„ umamiConfig.shareId ä¼šè‡ªåŠ¨ä»ä½ çš„é…ç½®æ–‡ä»¶è¯»å–
            const url = `https://cloud.umami.is/api/share/${umamiConfig.shareId}/stats?path=/posts/${slug}/`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                // å¦‚æœå®˜æ–¹æ¥å£æŠ¥é”™ï¼ˆæ¯”å¦‚ä½ æ²¡å¼€å¯â€œå…¬å¼€åˆ†äº«â€ï¼‰ï¼Œæˆ‘ä»¬é™é»˜å¤„ç†ï¼Œä¸æŠ¥çº¢å­—
                return;
            }

            const data = await response.json();
            
            // Umami è¿”å›çš„æ•°æ®ç»“æ„ä¸­ï¼Œpageviews.value æ˜¯æ€»æµè§ˆé‡
            const pageViews = data.pageviews?.value || 0;
            
            const viewsElement = document.getElementById(`page-views-${slug}`);
            if (viewsElement) {
                // åªæœ‰å½“æ•°å­—å¤§äº 0 æ—¶æ‰å±•ç¤ºåŠ¨ç”»ï¼Œå¦åˆ™æ˜¾ç¤ºâ€œæš‚æ— â€æˆ–â€œ0â€
                if (pageViews > 0) {
                    animateValue(viewsElement, 0, pageViews, 1000, 'æ¬¡');
                } else {
                    viewsElement.innerHTML = "0 æ¬¡";
                }
            }
        } catch (error) {
            // å½»åº•æ•è·é”™è¯¯ï¼Œä¸è®©å®ƒåœ¨æ§åˆ¶å°å˜çº¢
            console.log("Umami stats sync skipped."); 
        }
    }
            
            // å¦‚æœæ•°æ®æ¥è‡ªç¼“å­˜ï¼Œç›´æ¥æ˜¾ç¤ºç»“æœï¼Œè·³è¿‡åŠ¨ç”»
            if (statsData._fromCache) {
                if (viewsElement) viewsElement.innerHTML = `${pageViews} æ¬¡`;
                if (visitorsElement) visitorsElement.innerHTML = `${visits} äºº`;
                return;
            }

            if (viewsElement) {
                const currentViews = parseInt(viewsElement.textContent) || 0;
                if (currentViews !== pageViews) {
                    if (currentViews === 0) {
                         animateValue(viewsElement, currentViews, pageViews, 1000, 'æ¬¡');
                    } else {
                         viewsElement.innerHTML = `${pageViews} æ¬¡`;
                    }
                }
            }
            
            if (visitorsElement) {
                const currentVisits = parseInt(visitorsElement.textContent) || 0;
                if (currentVisits !== visits) {
                    if (currentVisits === 0) {
                         animateValue(visitorsElement, currentVisits, visits, 1000, 'äºº');
                    } else {
                         visitorsElement.innerHTML = `${visits} äºº`;
                    }
                }
            }
        } catch (error) {
            console.error('Error fetching page views:', error);
        }
    }
    */

    // è·å–è®¿é—®é‡ç»Ÿè®¡ (New Logic)
    async function fetchPageViews() {
        // if (!umamiConfig.enable) return; // Optional check
        try {
            const response = await fetch(`https://t.2x.nz/share?pathname=/posts/${slug}/`);
            if (!response.ok) return;
            const data = await response.json();
            const pageViews = data.views || 0;
            
            const viewsElement = document.getElementById(`page-views-${slug}`);
            
            if (viewsElement) {
                const currentViews = parseInt(viewsElement.textContent) || 0;
                if (currentViews !== pageViews) {
                    if (currentViews === 0) {
                         animateValue(viewsElement, currentViews, pageViews, 1000, 'æ¬¡');
                    } else {
                         viewsElement.innerHTML = `${pageViews} æ¬¡`;
                    }
                }
            }
        } catch (error) {
            console.error('Error fetching page views:', error);
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆåè·å–ç»Ÿè®¡æ•°æ®
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fetchPageViews);
    } else {
        fetchPageViews();
    }
</script>
)}
