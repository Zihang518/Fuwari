---
import { Icon } from "astro-icon/components";

import { umamiConfig } from "../config";
import { formatDateToYYYYMMDD } from "../utils/date-utils";
import { url, getDir } from "../utils/url-utils";

interface Props {
	class: string;
	published: Date;
	updated?: Date;
	hideUpdateDate?: boolean;
	hidePublishedDate?: boolean;
	slug?: string;
}
const {
	published,
	updated,
	hideUpdateDate = false,
	hidePublishedDate = false,
	slug,
} = Astro.props;
const className = Astro.props.class;
---

<div class:list={["flex flex-wrap text-neutral-500 dark:text-neutral-400 items-center gap-4 gap-x-4 gap-y-2", className]}>
    <!-- publish date -->
    {!hidePublishedDate && (
        <div class="flex items-center">
            <div class="meta-icon">
                <Icon name="material-symbols:calendar-today-outline-rounded" class="text-xl"></Icon>
            </div>
            <span class="text-50 text-sm font-medium">{formatDateToYYYYMMDD(published)}</span>
        </div>
    )}

    <!-- update date -->
    {!hideUpdateDate && updated && updated.getTime() !== published.getTime() && (
        <div class="flex items-center">
            <div class="meta-icon"
            >
                <Icon name="material-symbols:edit-calendar-outline-rounded" class="text-xl"></Icon>
            </div>
            <span class="text-50 text-sm font-medium">{formatDateToYYYYMMDD(updated)}</span>
        </div>
    )}

    <!-- page views & visitors -->
    {slug && (
        <>
            <div class="flex items-center">
                <div class="meta-icon">
                    <Icon name="material-symbols:visibility-outline-rounded" class="text-xl"></Icon>
                </div>
                <span class="text-50 text-sm font-medium" id={`page-views-${slug}`}>0 次</span>
            </div>
            <!--
            <div class="flex items-center">
                <div class="meta-icon">
                    <Icon name="material-symbols:person" class="text-xl"></Icon>
                </div>
                <span class="text-50 text-sm font-medium" id={`page-visitors-${slug}`}>0 人</span>
            </div>
            -->
        </>
    )}
</div>

{slug && (
    <script define:vars={{ slug, umamiConfig }}>
    // 数字动画函数
    function animateValue(obj, start, end, duration, suffix = '') {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = `${Math.floor(progress * (end - start) + start)} ${suffix}`;
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                obj.innerHTML = `${end} ${suffix}`;
            }
        };
        window.requestAnimationFrame(step);
    }

    // 获取访问量统计 (Archived: Old Logic)
    /*
    async function fetchPageViews() {
    // 1. 定义你的配置
    const websiteId = "4696c062-4271-4b8b-8ed7-b481f5961f28"; // 例如: 8848a-xxx-xxx
    const baseUrl = "https://u.xiegao.top";
    
    try {
        // 2. 构造请求 URL
        // 使用你的自建 API 终点，统计该路径的所有历史数据 (startAt=0)
        const url = `${baseUrl}/api/websites/${websiteId}/stats?path=/posts/${slug}/&startAt=0&endAt=${Date.now()}`;

        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });

        if (!response.ok) return;

        const data = await response.json();
        
        // 3. 提取阅读量 (自建版通常在 data.pageviews.value)
        const pageViews = data.pageviews?.value || 0;
        
        const viewsElement = document.getElementById(`page-views-${slug}`);
        
        if (viewsElement) {
            const currentViews = parseInt(viewsElement.textContent) || 0;
            if (currentViews !== pageViews) {
                if (currentViews === 0) {
                     animateValue(viewsElement, currentViews, pageViews, 1000, '次');
                } else {
                     viewsElement.innerHTML = `${pageViews} 次`;
                }
            }
        }
    } catch (error) {
        // 自建版如果挂了，我们静默失败，不给控制台报红字
        console.warn('Umami stats sync skipped.');
    }
}
            
            // 如果数据来自缓存，直接显示结果，跳过动画
            if (statsData._fromCache) {
                if (viewsElement) viewsElement.innerHTML = `${pageViews} 次`;
                if (visitorsElement) visitorsElement.innerHTML = `${visits} 人`;
                return;
            }

            if (viewsElement) {
                const currentViews = parseInt(viewsElement.textContent) || 0;
                if (currentViews !== pageViews) {
                    if (currentViews === 0) {
                         animateValue(viewsElement, currentViews, pageViews, 1000, '次');
                    } else {
                         viewsElement.innerHTML = `${pageViews} 次`;
                    }
                }
            }
            
            if (visitorsElement) {
                const currentVisits = parseInt(visitorsElement.textContent) || 0;
                if (currentVisits !== visits) {
                    if (currentVisits === 0) {
{slug && (
    <script define:vars={{ slug }}>
    // 数字动画函数
    function animateValue(obj, start, end, duration, suffix = '') {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = `${Math.floor(progress * (end - start) + start)} ${suffix}`;
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                obj.innerHTML = `${end} ${suffix}`;
            }
        };
        window.requestAnimationFrame(step);
    }

    // 获取访问量统计 (自建 Umami 逻辑)
    async function fetchPageViews() {
        // 1. 你的自建配置（直接写死最稳）
        const websiteId = "4696c062-4271-4b8b-8ed7-b481f5961f28";
        const baseUrl = "https://u.xiegao.top";
        
        try {
            // 2. 构造请求 URL (自建版 API 路径)
            const url = `${baseUrl}/api/websites/${websiteId}/stats?path=/posts/${slug}/&startAt=0&endAt=${Date.now()}`;

            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) return;

            const data = await response.json();
            
            // 3. 提取阅读量 (自建版数据结构在 pageviews.value)
            const pageViews = data.pageviews?.value || 0;
            
            const viewsElement = document.getElementById(`page-views-${slug}`);
            
            if (viewsElement) {
                // 正则过滤非数字字符，防止动画计算出错
                const currentViews = parseInt(viewsElement.textContent.replace(/[^\d]/g, '')) || 0;
                if (currentViews !== pageViews) {
                    if (currentViews === 0) {
                         animateValue(viewsElement, currentViews, pageViews, 1000, '次');
                    } else {
                         viewsElement.innerHTML = `${pageViews} 次`;
                    }
                }
            }
        } catch (error) {
            // 生产环境静默处理
            console.warn('Umami stats sync skipped.');
        }
    }

    // 页面加载或 Swup 内容替换后执行
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fetchPageViews);
    } else {
        fetchPageViews();
    }
    
    // 适配 Swup 等无刷新插件
    document.addEventListener('swup:contentReplaced', fetchPageViews);
</script>
)}
